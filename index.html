<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Professional Review Card Generator</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
/* --- Base Styles --- */
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #f0f2f5;
    margin: 0;
    padding: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    color: #333;
}
.container {
    background-color: #fff;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    width: 100%;
    max-width: 1000px;
    margin-bottom: 30px;
    text-align: center;
}
h1 { color: #1a73e8; margin-bottom: 10px; }
p { margin-bottom: 15px; line-height: 1.5; }
input[type="file"] { margin-bottom: 20px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; cursor: pointer; }
.button-group { display: flex; gap: 15px; justify-content: center; margin-bottom: 20px; }
.button-group button {
    background-color: #1a73e8;
    color: white;
    border: none;
    padding: 12px 25px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 16px;
    transition: background-color 0.3s ease;
}
.button-group .download-btn { background-color: #28a745; }
.button-group button:hover:not(:disabled) { background-color: #145cb7; }
.button-group .download-btn:hover:not(:disabled) { background-color: #218838; }
.button-group button:disabled { background-color: #cccccc; cursor: not-allowed; }
#reviewCardsContainer { display: flex; flex-wrap: wrap; gap: 30px; justify-content: center; margin-top: 30px; }

/* --- Review Card --- */
.review-card {
    width: 500px;
    height: 500px;
    background-color: #f0fdf4;
    border-radius: 15px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.15);
    position: relative;
    display: flex;
    flex-direction: column;
    color: #333;
    box-sizing: border-box;
}

/* Header */
.card-header {
    background-color: #10b981;
    color: white;
    padding: 25px;
    height: 100px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}
.card-title { font-size: 2.2em; font-weight: 800; margin:0; letter-spacing:2px; text-shadow:1px 1px 3px rgba(0,0,0,0.2);}
.card-subtitle { font-size: 1em; font-weight: 500; margin-top: 8px; opacity:0.9;}

/* Content area */
.card-content-area {
    flex-grow: 1;
    padding: 20px 25px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    position: relative;
    box-sizing: border-box;
}

/* Profile */
.profile-section {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    overflow: hidden;
    border: 5px solid white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    margin-bottom: 10px;
}
.profile-section::before {
    content: '';
    position: absolute;
    top: -8px; left: -8px; right: -8px; bottom: -8px;
    border: 4px solid #10b981;
    border-radius: 50%;
}

/* Feedback */
.feedback-section {
    width: 100%;
    height: 130px;
    position: relative;
    text-align: left;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    justify-content: center;
    margin-bottom: 10px;
}
.feedback-text {
    font-size: 0.95em;
    line-height: 1.5;
    color: #444;
    margin:0;
    text-align: justify;
}
.quote {
    position: absolute;
    font-size: 3.5em;
    color: #cccccc;
    font-family: serif;
    line-height: 0.6;
    z-index: 0;
}
.quote-top { top: -15px; left: 0; }
.quote-bottom { bottom: -15px; right: 0; transform: rotate(180deg); }

/* Student info */
.student-info-section { width:100%; text-align:left; padding-left:10px; }
.student-name { font-weight:bold; font-size:1.1em; margin-bottom:3px; }
.student-school-class { font-size:0.85em; color:#666; margin-bottom:5px; }
.student-class::before { content: ' | '; margin:0 5px; }
.star-rating { display:flex; gap:2px; }
.star { color:#ffc107; font-size:1.2em; }

/* Footer - FIXED inside card */
.card-footer {
    background-color: #f0fdf4;
    padding: 10px 25px;
    height: 60px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-top:1px solid #eee;
    flex-shrink:0;
    position: absolute;
    bottom:0;
    width:100%;
    box-sizing: border-box;
}
.footer-group { display:flex; flex-direction:column; gap:5px; flex-basis:33%; }
.footer-right-group { align-items:flex-end; }
.website-center { display:flex; justify-content:center; flex-basis:33%; white-space:nowrap; }
.social-link { display:flex; align-items:center; text-decoration:none; color:#555; font-size:0.75em; gap:3px; white-space:nowrap; }
.social-link img { width:16px; height:16px; vertical-align:middle; }
.website { font-size:0.9em; font-weight:bold; color:#333; display:flex; align-items:center; gap:5px; }
.website img { width:18px; height:18px; vertical-align:middle; }

/* Responsive */
@media (max-width:600px) {
    .review-card { width:100%; max-width:400px; height:auto;}
    .card-footer { flex-direction:column; gap:5px; height:auto;}
    .footer-group, .website-center { width:100%; justify-content:center; align-items:center;}
    .footer-right-group { align-items:center;}
}
</style>
</head>
<body>
<div class="container">
<h1>Professional Review Card Generator</h1>
<p>Upload an Excel file (XLSX) with student reviews.</p>
<p>Columns: `Name`, `School`, `Class`, `Rating` (1-5), `Feedback`, `Image Link`</p>
<input type="file" id="excelFileInput" accept=".xlsx, .xls">
<div class="button-group">
<button id="previewCardsBtn" disabled>1. Preview Review Cards</button>
<button id="downloadCardsBtn" disabled class="download-btn">2. Download All as PNG</button>
</div>
<p style="color:red; font-size: 0.8em;">*Google Drive images require public access.</p>
<div id="reviewCardsContainer"></div>
</div>

<!-- Template -->
<template id="reviewCardTemplate">
<div class="review-card">
<div class="card-header">
<div class="card-title">REVIEW</div>
<div class="card-subtitle">Summer Research Program 2025</div>
</div>
<div class="card-content-area">
<div class="profile-section">
<img src="" alt="Profile Picture" class="profile-pic">
</div>
<div class="feedback-section">
<div class="quote quote-top">“</div>
<p class="feedback-text"></p>
<div class="quote quote-bottom">”</div>
</div>
<div class="student-info-section">
<div class="student-name"></div>
<div class="student-school-class">
<span class="student-school"></span>
<span class="student-class"></span>
</div>
<div class="star-rating"></div>
</div>
</div>
<div class="card-footer">
<div class="footer-group footer-left-group">
<a href="#" class="social-link"><img src="https://img.icons8.com/ios-filled/50/000000/facebook-new.png"> yrjournal</a>
<a href="#" class="social-link"><img src="https://img.icons8.com/ios-filled/50/000000/youtube.png"> @yrjournal</a>
</div>
<div class="website-center">
<div class="website">
<img src="https://img.icons8.com/ios-filled/24/000000/globe--v1.png"> yrjournal.org
</div>
</div>
<div class="footer-group footer-right-group">
<a href="#" class="social-link"><img src="https://img.icons8.com/ios-filled/50/000000/instagram-new--v1.png"> youthrjournal</a>
<a href="#" class="social-link"><img src="https://img.icons8.com/ios-filled/50/000000/linkedin.png"> company/yrj</a>
</div>
</div>
</div>
</template>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const excelFileInput = document.getElementById('excelFileInput');
    const previewCardsBtn = document.getElementById('previewCardsBtn');
    const downloadCardsBtn = document.getElementById('downloadCardsBtn');
    const reviewCardsContainer = document.getElementById('reviewCardsContainer');
    const reviewCardTemplate = document.getElementById('reviewCardTemplate');
    let studentData = [];

    function getFixedImageUrl(link){
        const driveRegex = /(https:\/\/(?:drive\.google\.com\/(?:file\/d\/|open\?id=))([a-zA-Z0-9_-]+))/;
        const match = link.match(driveRegex);
        if(match && match[2]){
            const fileId = match[2];
            return `https://corsproxy.io/?https://drive.google.com/uc?export=view&id=${fileId}`;
        }
        return link;
    }

    function adjustFeedbackFontSize(feedbackElement, containerElement){
        let maxFont = 0.95, minFont=0.6, font=maxFont;
        feedbackElement.style.fontSize = font+'em';
        while(feedbackElement.scrollHeight > containerElement.clientHeight && font>minFont){
            font-=0.02;
            feedbackElement.style.fontSize = font+'em';
        }
        feedbackElement.style.overflow = (feedbackElement.scrollHeight>containerElement.clientHeight)? 'auto':'hidden';
    }

    excelFileInput.addEventListener('change',(e)=>{
        const file = e.target.files[0];
        if(file) readExcelFile(file);
        else { studentData=[]; previewCardsBtn.disabled=true; downloadCardsBtn.disabled=true; reviewCardsContainer.innerHTML=''; }
    });

    previewCardsBtn.addEventListener('click',()=>{
        if(studentData.length>0){ generateReviewCards(studentData); downloadCardsBtn.disabled=false; }
        else alert("Please upload Excel file first.");
    });

    downloadCardsBtn.addEventListener('click', async ()=>{
        if(studentData.length>0 && reviewCardsContainer.children.length>0) await downloadAllCardsAsPng();
        else alert("Preview cards first.");
    });

    function readExcelFile(file){
        const reader = new FileReader();
        reader.onload = (e)=>{
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data,{type:'array'});
            const firstSheet = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheet];
            studentData = XLSX.utils.sheet_to_json(worksheet);
            const required=['Name','School','Class','Rating','Feedback','Image Link'];
            const missing = required.filter(c=>!studentData[0]||!studentData[0].hasOwnProperty(c));
            if(missing.length>0){ alert(`Missing columns: ${missing.join(',')}`); studentData=[]; previewCardsBtn.disabled=true; }
            else previewCardsBtn.disabled=false;
        };
        reader.readAsArrayBuffer(file);
    }

    function generateReviewCards(data){
        reviewCardsContainer.innerHTML='';
        data.forEach((student,index)=>{
            const card = reviewCardTemplate.content.cloneNode(true).firstElementChild;
            const imgUrl = getFixedImageUrl(student['Image Link']||'');
            card.querySelector('.profile-pic').src = imgUrl || 'https://via.placeholder.com/100';
            card.querySelector('.profile-pic').alt = student['Name']+' Profile';
            const feedbackEl = card.querySelector('.feedback-text');
            feedbackEl.textContent = student['Feedback'];
            card.querySelector('.student-name').textContent = student['Name'];
            card.querySelector('.student-school').textContent = student['School'];
            card.querySelector('.student-class').textContent = student['Class'];

            const stars = card.querySelector('.star-rating');
            stars.innerHTML='';
            const rating = Math.min(5, Math.max(0, parseInt(student['Rating'])));
            for(let i=0;i<5;i++){ const s=document.createElement('span'); s.classList.add('star'); s.innerHTML=(i<rating?'&#9733;':'&#9734;'); stars.appendChild(s); }

            card.style.position='absolute';
            card.style.visibility='hidden';
            reviewCardsContainer.appendChild(card);
            adjustFeedbackFontSize(feedbackEl, card.querySelector('.feedback-section'));
            card.style.position=''; card.style.visibility='';
        });
    }

    async function downloadAllCardsAsPng(){
        const cards = Array.from(reviewCardsContainer.children);
        if(!cards.length) return;
        downloadCardsBtn.textContent='Downloading...'; downloadCardsBtn.disabled=true; previewCardsBtn.disabled=true;
        for(let i=0;i<cards.length;i++){
            const card = cards[i];
            card.style.position='absolute'; card.style.left='-9999px'; card.style.top='-9999px'; card.style.width='500px'; card.style.height='500px';
            await html2canvas(card,{scale:2,useCORS:true,allowTaint:false,backgroundColor:null,width:500,height:500}).then(c=>{
                const link=document.createElement('a');
                const fname = studentData[i]['Name'].replace(/[^a-zA-Z0-9]/g,'_').substring(0,30);
                link.download=`${fname}_IG_Review.png`;
                link.href = c.toDataURL('image/png');
                link.click();
            }).catch(err=>console.error(err));
            card.style.position=''; card.style.left=''; card.style.top=''; card.style.width=''; card.style.height='';
        }
        alert("All review cards generated!"); downloadCardsBtn.textContent='2. Download All as PNG'; downloadCardsBtn.disabled=false; previewCardsBtn.disabled=false;
    }

});
</script>
</body>
</html>
